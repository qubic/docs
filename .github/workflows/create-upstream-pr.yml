name: Create Upstream PR

on:
  pull_request:
    types: [closed]
    branches: [main]
  workflow_dispatch:  # Manuelles Triggern mÃ¶glich

jobs:
  create-upstream-pr:
    if: github.event_name == 'workflow_dispatch' || (github.event.pull_request.merged == true && contains(github.event.pull_request.title, '[REVIEW NEEDED]'))
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout your fork
        uses: actions/checkout@v4
        with:
          repository: ${{ github.actor }}/qubic-docs-de
          token: ${{ secrets.UPSTREAM_PR_TOKEN }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "Qubic Translation Bot"
          git config user.email "translation-bot@qubic-network.de"

      - name: Create branch with only translations
        run: |
          # Neuen Branch erstellen
          BRANCH_NAME="german-translations-$(date +%Y%m%d)"
          git checkout -b $BRANCH_NAME
          
          # Nur i18n/de/ behalten, Rest entfernen
          mkdir -p /tmp/translations
          cp -r i18n/de/ /tmp/translations/
          
          # Alles lÃ¶schen auÃŸer .git
          find . -mindepth 1 -maxdepth 1 ! -name '.git' -exec rm -rf {} +
          
          # i18n wiederherstellen
          mkdir -p i18n
          cp -r /tmp/translations/de/ i18n/
          
          # Commit erstellen
          git add i18n/de/
          git commit -m "Add German translations
          
          - Translated via DeepSeek API with human review
          - Covers latest documentation updates
          - All technical terms preserved
          - Includes overview section
          
          Co-authored-by: ${{ github.actor }}"
          
          # Branch pushen
          git push origin $BRANCH_NAME
          
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_ENV
          echo "âœ“ Branch $BRANCH_NAME erstellt und gepusht"

      - name: Create Pull Request to qubic/docs
        env:
          GITHUB_TOKEN: ${{ secrets.UPSTREAM_PR_TOKEN }}
        run: |
          # Cross-Repository PR erstellen
          gh pr create \
            --repo qubic/docs \
            --title "German Translation Update - $(date +%Y-%m-%d)" \
            --body "$(cat << 'PRBODY'
          ## ðŸ‡©ðŸ‡ª German Translation Update
          
          This PR adds German translations for the Qubic documentation.
          
          ### What's included:
          - âœ… Latest translations synchronized with upstream
          - âœ… AI-translated via DeepSeek API
          - âœ… Reviewed by human translator
          - âœ… All technical terms preserved
          - âœ… Proper Docusaurus i18n structure (`i18n/de/`)
          
          ### Files changed:
          - German translations in `i18n/de/docusaurus-plugin-content-docs/current/`
          
          ### How to test:
          1. Pull this branch
          2. Add to `docusaurus.config.js`:
             ```javascript
             i18n: {
               defaultLocale: 'en',
               locales: ['en', 'de'],
             }
             ```
          3. Run `npm run start`
          4. Visit `http://localhost:3000/de/`
          
          ### Requirements for merge:
          - [ ] Add `de` to `locales` in `docusaurus.config.js`
          - [ ] Verify build succeeds: `npm run build`
          - [ ] Check German pages render correctly
          
          ### Maintenance:
          - Translations are automatically synced daily
          - New PRs will be created for future updates
          - This is a one-time setup - future updates just need merge
          
          ---
          *Automated translation workflow by @${{ github.actor }}*  
          *For questions about translations, please contact the German translation team*
          PRBODY
          )" \
            --head ${{ github.actor }}:${{ env.branch_name }} \
            --base main

      - name: Notify success
        run: |
          echo "========================================"
          echo "âœ… PR erfolgreich erstellt!"
          echo ""
          echo "Der Qubic-Maintainer bekommt jetzt:"
          echo "- Nur den i18n/de/ Ordner"
          echo "- Keine Workflow-Dateien"
          echo "- Keine Scripts"
          echo ""
          echo "Link zum PR:"
          echo "https://github.com/qubic/docs/pulls"
          echo "========================================"
