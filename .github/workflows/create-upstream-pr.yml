name: Create Upstream PR

on:
  pull_request:
    types: [closed]
    branches: [main]
  workflow_dispatch:  # Manuelles Triggern m√∂glich

jobs:
  create-upstream-pr:
    if: github.event_name == 'workflow_dispatch' || (github.event.pull_request.merged == true && contains(github.event.pull_request.title, '[REVIEW NEEDED]'))
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout your fork
        uses: actions/checkout@v4
        with:
          repository: ${{ github.actor }}/qubic-docs-de
          token: ${{ secrets.UPSTREAM_PR_TOKEN }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "Qubic Translation Bot"
          git config user.email "translation-bot@qubic-network.de"

      - name: Find changed translation files
        id: changed-files
        run: |
          # Bei manuellem Start: Alle aktuellen i18n Dateien verwenden
          # Bei automatischem Start: Vergleiche mit letztem erfolgreichen Upstream-PR
          
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # Manueller Start - nimm alle aktuellen Dateien
            echo "Manueller Start - verwende alle aktuellen √úbersetzungsdateien"
            CHANGED_FILES=$(git ls-files i18n/de/)
          else
            # Automatischer Start nach Merge - finde letzten Upstream-PR-Commit
            # Suche nach Commits die "Add/Update German translations" enthalten
            LAST_UPSTREAM_COMMIT=$(git log --grep="Add/Update German translations" --format="%H" -n 1 || echo "")
            
            if [ -z "$LAST_UPSTREAM_COMMIT" ]; then
              echo "Kein vorheriger Upstream-PR gefunden, verwende alle Dateien"
              CHANGED_FILES=$(git ls-files i18n/de/)
            else
              echo "Letzter Upstream-PR Commit: $LAST_UPSTREAM_COMMIT"
              CHANGED_FILES=$(git diff --name-only $LAST_UPSTREAM_COMMIT HEAD -- i18n/de/)
            fi
          fi
          
          if [ -z "$CHANGED_FILES" ]; then
            echo "Keine neuen √úbersetzungen gefunden"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Ge√§nderte Dateien:"
          echo "$CHANGED_FILES"
          
          # Speichere f√ºr sp√§ter
          echo "$CHANGED_FILES" > /tmp/changed_files.txt
          echo "has_changes=true" >> $GITHUB_OUTPUT

      - name: Create branch with only translation changes
        if: steps.changed-files.outputs.has_changes == 'true'
        run: |
          # Neuen Branch erstellen (von main aus)
          BRANCH_NAME="german-translations-$(date +%Y%m%d)"
          git checkout -b $BRANCH_NAME
          
          # Nur die ge√§nderten Dateien ausw√§hlen
          while IFS= read -r file; do
            if [ -f "$file" ]; then
              git add "$file"
              echo "Added: $file"
            fi
          done < /tmp/changed_files.txt
          
          # Status anzeigen
          echo "Git Status:"
          git status
          
          # Commit erstellen
          git commit -m "Add/Update German translations
          
          - Translated via DeepSeek API with human review
          - Covers latest documentation updates
          - All technical terms preserved
          - Only changed files included
          
          Co-authored-by: ${{ github.actor }}"
          
          # Branch pushen (force, falls er schon existiert)
          git push -f origin $BRANCH_NAME
          
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_ENV
          echo "‚úì Branch $BRANCH_NAME erstellt und gepusht"

      - name: Create Pull Request to qubic/docs
        if: steps.changed-files.outputs.has_changes == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.UPSTREAM_PR_TOKEN }}
        run: |
          # Cross-Repository PR erstellen
          gh pr create \
            --repo qubic/docs \
            --title "German Translation Update - $(date +%Y-%m-%d)" \
            --body "$(cat << 'PRBODY'
          ## üá©üá™ German Translation Update
          
          This PR adds German translations for the Qubic documentation.
          
          ### What's included:
          - ‚úÖ Latest translations synchronized with upstream
          - ‚úÖ AI-translated via DeepSeek API
          - ‚úÖ Reviewed by human translator
          - ‚úÖ All technical terms preserved
          - ‚úÖ Proper Docusaurus i18n structure (`i18n/de/`)
          
          ### Files changed:
          - German translations in `i18n/de/docusaurus-plugin-content-docs/current/`
          
          ### How to test:
          1. Pull this branch
          2. Add to `docusaurus.config.js`:
             ```javascript
             i18n: {
               defaultLocale: 'en',
               locales: ['en', 'de'],
             }
             ```
          3. Run `npm run start`
          4. Visit `http://localhost:3000/de/`
          
          ### Requirements for merge:
          - [ ] Add `de` to `locales` in `docusaurus.config.js`
          - [ ] Verify build succeeds: `npm run build`
          - [ ] Check German pages render correctly
          
          ### Maintenance:
          - Translations are automatically synced daily
          - New PRs will be created for future updates
          - This is a one-time setup - future updates just need merge
          
          ---
          *Automated translation workflow by @${{ github.actor }}*  
          *For questions about translations, please contact the German translation team*
          PRBODY
          )" \
            --head ${{ github.actor }}:${{ env.branch_name }} \
            --base main

      - name: Notify success
        run: |
          echo "========================================"
          echo "‚úÖ PR erfolgreich erstellt!"
          echo ""
          echo "Der Qubic-Maintainer bekommt jetzt:"
          echo "- Nur den i18n/de/ Ordner"
          echo "- Keine Workflow-Dateien"
          echo "- Keine Scripts"
          echo ""
          echo "Link zum PR:"
          echo "https://github.com/qubic/docs/pulls"
          echo "========================================"
