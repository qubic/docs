name: Test Translation - Single File

on:
  workflow_dispatch:  # Nur manuelles Triggern

env:
  DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
  TEST_FILE: "docs/overview/introduction.md"  # Hier die Testdatei ändern

jobs:
  test-translation:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      # 1. Checkout
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # 2. Git-Konfiguration
      - name: Configure Git
        run: |
          git config user.name "Qubic Translation Bot"
          git config user.email "translation-bot@qubic-network.de"

      # 3. Node.js Setup
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 4. Dependencies installieren
      - name: Install dependencies
        run: |
          npm init -y
          npm install axios front-matter

      # 5. Test-Übersetzungsscript erstellen
      - name: Create test translation script
        run: |
          cat > test-translate.js << 'EOF'
          const fs = require('fs');
          const path = require('path');
          const axios = require('axios');

          const DEEPSEEK_API_URL = 'https://api.deepseek.com/v1/chat/completions';
          const DEEPSEEK_API_KEY = process.env.DEEPSEEK_API_KEY;
          const TEST_FILE = process.env.TEST_FILE;

          // Übersetzungsprompt für technische Dokumentation
          const TRANSLATION_PROMPT = `Du bist ein professioneller Übersetzer für technische Blockchain-Dokumentation.
          Übersetze den folgenden Text ins Deutsche:
          
          Regeln:
          1. Behalte alle Markdown-Formatierungen bei (##, **, \`\`\`, etc.)
          2. Übersetze Code-Kommentare, aber NICHT Code-Blöcke
          3. Behalte technische Begriffe wie "quorum", "computor", "epoch" bei oder übersetze sie konsistent
          4. Behalte URLs und Dateipfade unverändert
          5. Behalte YAML-Frontmatter-Struktur bei
          6. Verwende professionelle, klare Sprache
          7. Achte auf korrekte deutsche Grammatik und Zeichensetzung
          
          Text zum Übersetzen:
          `;

          async function translateText(text) {
            try {
              const response = await axios.post(
                DEEPSEEK_API_URL,
                {
                  model: 'deepseek-chat',
                  messages: [
                    {
                      role: 'system',
                      content: 'Du bist ein Experte für technische Übersetzungen im Blockchain-Bereich.'
                    },
                    {
                      role: 'user',
                      content: TRANSLATION_PROMPT + text
                    }
                  ],
                  temperature: 0.3,
                  max_tokens: 4000
                },
                {
                  headers: {
                    'Authorization': `Bearer ${DEEPSEEK_API_KEY}`,
                    'Content-Type': 'application/json'
                  }
                }
              );

              return response.data.choices[0].message.content;
            } catch (error) {
              console.error('Translation error:', error.response?.data || error.message);
              throw error;
            }
          }

          // Simple Funktion um Frontmatter zu parsen
          function parseFrontmatter(content) {
            const match = content.match(/^---\n([\s\S]*?)\n---\n([\s\S]*)$/);
            if (!match) return { frontmatter: {}, body: content };
            
            const frontmatterText = match[1];
            const body = match[2].trim();
            const frontmatter = {};
            
            frontmatterText.split('\n').forEach(line => {
              const colonIndex = line.indexOf(':');
              if (colonIndex > 0) {
                const key = line.substring(0, colonIndex).trim();
                let value = line.substring(colonIndex + 1).trim();
                // Entferne Anführungszeichen
                if ((value.startsWith('"') && value.endsWith('"')) || 
                    (value.startsWith("'") && value.endsWith("'"))) {
                  value = value.slice(1, -1);
                }
                // Parse numbers
                if (!isNaN(value) && value !== '') {
                  frontmatter[key] = parseInt(value);
                } else {
                  frontmatter[key] = value;
                }
              }
            });
            
            return { frontmatter, body };
          }

          // Funktion um Frontmatter als sauberes YAML zu formatieren
          function formatFrontmatter(obj) {
            const lines = [];
            for (const [key, value] of Object.entries(obj)) {
              if (typeof value === 'string') {
                // Immer einfache Anführungszeichen verwenden
                lines.push(`${key}: '${value}'`);
              } else {
                lines.push(`${key}: ${value}`);
              }
            }
            return lines.join('\n');
          }

          async function translateFile(inputPath, outputPath) {
            console.log(`\n========================================`);
            console.log(`Testing translation of: ${inputPath}`);
            console.log(`========================================\n`);
            
            if (!fs.existsSync(inputPath)) {
              console.error(`❌ Datei nicht gefunden: ${inputPath}`);
              process.exit(1);
            }
            
            const content = fs.readFileSync(inputPath, 'utf-8');
            const { frontmatter, body } = parseFrontmatter(content);
            
            console.log(`✓ Datei geladen: ${inputPath}`);
            console.log(`✓ Größe: ${content.length} Zeichen`);
            console.log(`✓ Frontmatter gefunden: ${JSON.stringify(frontmatter)}\n`);

            console.log('Starte Übersetzung...\n');

            const translatedBody = await translateText(body);

            // Frontmatter übersetzen
            const translatedFrontmatter = { ...frontmatter };
            if (frontmatter.title) {
              console.log('Übersetze title...');
              translatedFrontmatter.title = await translateText(frontmatter.title);
            }
            if (frontmatter.sidebar_label) {
              console.log('Übersetze sidebar_label...');
              translatedFrontmatter.sidebar_label = await translateText(frontmatter.sidebar_label);
            }
            if (frontmatter.description) {
              console.log('Übersetze description...');
              translatedFrontmatter.description = await translateText(frontmatter.description);
            }

            // Zusammenbauen
            const yamlFrontmatter = formatFrontmatter(translatedFrontmatter);
            const output = `---\n${yamlFrontmatter}\n---\n\n${translatedBody}`;

            fs.mkdirSync(path.dirname(outputPath), { recursive: true });
            fs.writeFileSync(outputPath, output);
            
            console.log(`\n✓ Übersetzung gespeichert: ${outputPath}`);
            console.log(`\n--- Frontmatter ---`);
            console.log(yamlFrontmatter);
          }

          async function main() {
            const inputPath = TEST_FILE;
            const outputPath = inputPath.replace('docs/', 'i18n/de/docusaurus-plugin-content-docs/current/');
            
            try {
              await translateFile(inputPath, outputPath);
              console.log('\n✓ Test-Übersetzung erfolgreich!');
            } catch (error) {
              console.error('\n❌ Fehler:', error.message);
              process.exit(1);
            }
          }

          main().catch(console.error);
          EOF

      # 6. Test-Übersetzung ausführen
      - name: Run test translation
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          TEST_FILE: ${{ env.TEST_FILE }}
        run: node test-translate.js

      # 7. Änderungen committen und pushen
      - name: Commit and push translation
        run: |
          echo "========================================"
          echo "Übersetzte Datei wird committet..."
          git add i18n/de/
          git commit -m "Test translation: $(basename ${{ env.TEST_FILE }})
          
          Automated test translation of ${{ env.TEST_FILE }}"
          git push origin main
          echo "✓ Datei wurde in dein Repository gepusht!"
          echo ""
          echo "Du kannst sie jetzt lokal pullen mit:"
          echo "  git pull origin main"
          echo ""
          echo "Oder auf GitHub ansehen unter:"
          echo "  https://github.com/${{ github.repository }}/blob/main/i18n/de/docusaurus-plugin-content-docs/current/${{ env.TEST_FILE }}"

      # 8. Artifact erstellen (zum Download)
      - name: Upload translation as artifact
        uses: actions/upload-artifact@v4
        with:
          name: german-translation
          path: i18n/de/docusaurus-plugin-content-docs/current/overview/introduction.md
          retention-days: 7
          
      - name: Show download info
        run: |
          echo "========================================"
          echo "✓ Artifact erstellt!"
          echo ""
          echo "Du kannst die Datei hier herunterladen:"
          echo "  GitHub Actions → Dieser Workflow-Run → Artifacts"
          echo "========================================"
          echo ""
          echo "Die übersetzte Datei liegt unter:"
          echo "  i18n/de/docusaurus-plugin-content-docs/current/overview/introduction.md"
