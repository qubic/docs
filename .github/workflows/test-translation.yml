name: Test Translation - Single File

on:
  workflow_dispatch:  # Nur manuelles Triggern

env:
  DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
  TEST_FILE: "docs/overview/introduction.md"  # Hier die Testdatei ändern

jobs:
  test-translation:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      # 1. Checkout
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # 2. Git-Konfiguration
      - name: Configure Git
        run: |
          git config user.name "Qubic Translation Bot"
          git config user.email "translation-bot@qubic-network.de"

      # 3. Node.js Setup
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 4. Dependencies installieren
      - name: Install dependencies
        run: |
          npm init -y
          npm install axios front-matter

      # 5. Test-Übersetzungsscript erstellen
      - name: Create test translation script
        run: |
          cat > test-translate.js << 'EOF'
          const fs = require('fs');
          const path = require('path');
          const axios = require('axios');
          const matter = require('front-matter');

          const DEEPSEEK_API_URL = 'https://api.deepseek.com/v1/chat/completions';
          const DEEPSEEK_API_KEY = process.env.DEEPSEEK_API_KEY;
          const TEST_FILE = process.env.TEST_FILE;

          // Übersetzungsprompt für technische Dokumentation
          const TRANSLATION_PROMPT = `Du bist ein professioneller Übersetzer für technische Blockchain-Dokumentation.
          Übersetze den folgenden Text ins Deutsche:
          
          Regeln:
          1. Behalte alle Markdown-Formatierungen bei (##, **, \`\`\`, etc.)
          2. Übersetze Code-Kommentare, aber NICHT Code-Blöcke
          3. Behalte technische Begriffe wie "quorum", "computor", "epoch" bei oder übersetze sie konsistent
          4. Behalte URLs und Dateipfade unverändert
          5. Behalte YAML-Frontmatter-Struktur bei
          6. Verwende professionelle, klare Sprache
          7. Achte auf korrekte deutsche Grammatik und Zeichensetzung
          
          Text zum Übersetzen:
          `;

          async function translateText(text) {
            try {
              const response = await axios.post(
                DEEPSEEK_API_URL,
                {
                  model: 'deepseek-chat',
                  messages: [
                    {
                      role: 'system',
                      content: 'Du bist ein Experte für technische Übersetzungen im Blockchain-Bereich.'
                    },
                    {
                      role: 'user',
                      content: TRANSLATION_PROMPT + text
                    }
                  ],
                  temperature: 0.3,
                  max_tokens: 4000
                },
                {
                  headers: {
                    'Authorization': `Bearer ${DEEPSEEK_API_KEY}`,
                    'Content-Type': 'application/json'
                  }
                }
              );

              return response.data.choices[0].message.content;
            } catch (error) {
              console.error('Translation error:', error.response?.data || error.message);
              throw error;
            }
          }

          // Hilfsfunktion um Frontmatter als YAML zu formatieren
          function formatFrontmatter(obj) {
            const lines = [];
            for (const [key, value] of Object.entries(obj)) {
              if (value === null || value === undefined) {
                lines.push(`${key}:`);
              } else if (typeof value === 'string') {
                // Strings mit Sonderzeichen in Anführungszeichen
                if (value.includes(':') || value.includes('#') || value.includes('"') || value.includes("'") || value.includes('\n')) {
                  lines.push(`${key}: "${value.replace(/"/g, '\\"')}"`);
                } else {
                  lines.push(`${key}: ${value}`);
                }
              } else if (typeof value === 'number' || typeof value === 'boolean') {
                lines.push(`${key}: ${value}`);
              } else if (Array.isArray(value)) {
                lines.push(`${key}:`);
                value.forEach(item => lines.push(`  - ${item}`));
              } else {
                lines.push(`${key}: ${value}`);
              }
            }
            return lines.join('\n');
          }

          async function translateFile(inputPath, outputPath) {
            console.log(`\n========================================`);
            console.log(`Testing translation of: ${inputPath}`);
            console.log(`========================================\n`);
            
            // Prüfe ob Datei existiert
            if (!fs.existsSync(inputPath)) {
              console.error(`❌ Datei nicht gefunden: ${inputPath}`);
              process.exit(1);
            }
            
            const content = fs.readFileSync(inputPath, 'utf-8');
            const parsed = matter(content);
            
            console.log(`✓ Datei geladen: ${inputPath}`);
            console.log(`✓ Größe: ${content.length} Zeichen`);
            console.log(`✓ Frontmatter gefunden: ${Object.keys(parsed.frontmatter).join(', ')}\n`);

            console.log('Starte Übersetzung...\n');

            // Übersetze den Hauptinhalt
            const translatedBody = await translateText(parsed.body);

            // Frontmatter: Übersetze nur bestimmte Felder
            const translatedFrontmatter = { ...parsed.frontmatter };
            if (parsed.frontmatter.title) {
              console.log('Übersetze Titel...');
              translatedFrontmatter.title = await translateText(parsed.frontmatter.title);
            }
            if (parsed.frontmatter.description) {
              console.log('Übersetze Beschreibung...');
              translatedFrontmatter.description = await translateText(parsed.frontmatter.description);
            }
            // sidebar_label auch übersetzen falls vorhanden
            if (parsed.frontmatter.sidebar_label) {
              console.log('Übersetze sidebar_label...');
              translatedFrontmatter.sidebar_label = await translateText(parsed.frontmatter.sidebar_label);
            }

            // Zusammenbauen mit korrektem YAML-Format
            const yamlFrontmatter = formatFrontmatter(translatedFrontmatter);
            const output = `---\n${yamlFrontmatter}\n---\n\n${translatedBody}`;

            // Sicherstellen, dass das Ausgabeverzeichnis existiert
            fs.mkdirSync(path.dirname(outputPath), { recursive: true });
            fs.writeFileSync(outputPath, output);
            
            console.log(`\n✓ Übersetzung gespeichert: ${outputPath}`);
            console.log(`✓ Ausgabegröße: ${output.length} Zeichen`);
            
            // Zeige ersten Absatz als Vorschau
            console.log(`\n--- Vorschau Frontmatter ---`);
            console.log(`---\n${yamlFrontmatter}\n---`);
            console.log(`\n--- Vorschau Inhalt (erster Absatz) ---`);
            const firstParagraph = translatedBody.split('\n\n')[0];
            console.log(firstParagraph.substring(0, 300));
            if (firstParagraph.length > 300) console.log('...');
            console.log(`\n✓ Übersetzung komplett!`);
          }

          async function main() {
            const inputPath = TEST_FILE;
            const outputPath = inputPath.replace('docs/', 'i18n/de/docusaurus-plugin-content-docs/current/');
            
            try {
              await translateFile(inputPath, outputPath);
              console.log('\n========================================');
              console.log('✓ Test-Übersetzung erfolgreich!');
              console.log('========================================\n');
            } catch (error) {
              console.error('\n❌ Fehler bei der Übersetzung:', error.message);
              console.error(error.stack);
              process.exit(1);
            }
          }

          main().catch(console.error);
          EOF

      # 6. Test-Übersetzung ausführen
      - name: Run test translation
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          TEST_FILE: ${{ env.TEST_FILE }}
        run: node test-translate.js

      # 7. Änderungen committen und pushen
      - name: Commit and push translation
        run: |
          echo "========================================"
          echo "Übersetzte Datei wird committet..."
          git add i18n/de/
          git commit -m "Test translation: $(basename ${{ env.TEST_FILE }})
          
          Automated test translation of ${{ env.TEST_FILE }}"
          git push origin main
          echo "✓ Datei wurde in dein Repository gepusht!"
          echo ""
          echo "Du kannst sie jetzt lokal pullen mit:"
          echo "  git pull origin main"
          echo ""
          echo "Oder auf GitHub ansehen unter:"
          echo "  https://github.com/${{ github.repository }}/blob/main/i18n/de/docusaurus-plugin-content-docs/current/${{ env.TEST_FILE }}"

      # 8. Artifact erstellen (zum Download)
      - name: Upload translation as artifact
        uses: actions/upload-artifact@v4
        with:
          name: german-translation
          path: i18n/de/docusaurus-plugin-content-docs/current/overview/introduction.md
          retention-days: 7
          
      - name: Show download info
        run: |
          echo "========================================"
          echo "✓ Artifact erstellt!"
          echo ""
          echo "Du kannst die Datei hier herunterladen:"
          echo "  GitHub Actions → Dieser Workflow-Run → Artifacts"
          echo "========================================"
          echo ""
          echo "Die übersetzte Datei liegt unter:"
          echo "  i18n/de/docusaurus-plugin-content-docs/current/overview/introduction.md"
